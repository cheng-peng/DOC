# 熊猫英文版项目交接
[TOC]

## 埋码 
### 埋码工具类 (CountEnUtils.class)
#### WD埋码

##### 方法说明

* wdCount(final Context context,  final String page, final String module, final String title)：数据统计
```
    /**
     * 数据统计   默认行为类型：点击
     *
     * @param context
     * @param page    页面      没有传 "-"
     * @param module  模块名称  没有传 "-"
     * @param title   事件名称  没有传 "-"
     */
    public static void wdCount(final Context context,  final String page, final String module, final String title) {

        new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    String strPage = "-";
                    if (page != null && page.length() != 0) {
                        strPage = page;
                    }
                    String strModule = "-";
                    if (module != null && module.length() != 0) {
                        strModule = module;
                    }
                    ArrayList<Pair<String, String>> pairs = new ArrayList<>();
                    pairs.add(new Pair<>(getString(R.string.page), strPage));
                    pairs.add(new Pair<>(getString(R.string.module_name), strModule));
                    pairs.add(new Pair<>(getString(R.string.behavior_type), getString(R.string.behavior_click)));
                    GridsumWebDissector.getInstance().trackEvent((Activity) context, "-", title, "-", 200, pairs);
                    Log.e(TAG, "事件名称：" + title + " | 页面：" + strPage + " | 模块名称：" + strModule + " | 行为类型：点击 ");
                } catch (Exception e) {
                }
            }
        }).start();
    }
```

##### 使用方法 （各个页面里都有使用方法，以下只是举个例子）
```
    // 埋码 数据统计 设置
    CountEnUtils.wdCount(mContext,"设置",null,"Clear cache");

    // 埋码 数据统计 点赞
    CountEnUtils.wdCount(mContext, "直播播放页", "点赞", channTitle);
```

#### VD埋码
##### 方法说明

* vdCount(Context context, VideoModel videoModel, Boolean isVod)：视频统计初始化
```
    /**
     * 视频统计初始化
     * videoModel 视频实体类
     * isVod true：点播  fasle：直播
     * status 枚举
     */
    public static void vdCount(Context context, VideoModel videoModel, Boolean isVod) {

        context = context.getApplicationContext();
        try {

            if (isVod) {
                videoType = 0;
            } else {
                videoType = 1;
            }

            VideoTracker tracker = VideoTracker.getInstance("GVD-200103", "GSD-200103", context);
            //传入设备型号
            tracker.setMfrs(android.os.Build.MODEL);
            //传入播放平台
            tracker.setDevice("Android");
            //传入操作系统
            tracker.setChip("Android" + android.os.Build.VERSION.RELEASE);

            //视频ID
            VideoInfo videoInfo = new VideoInfo(videoModel.getVid(), context);
            //视频名称
            videoInfo.VideoName = videoModel.getVdName();
            //视频地址
            videoInfo.VideoUrl = videoModel.getVdUrl();
            // 设置视频加速对应的加速渠道厂商
            videoInfo.Cdn = videoModel.getCdn();
            if (isVod) {
                // 直播 填 “直播名称”  点播 填 “-”
                videoInfo.VideoTVChannel = "-";
                //获取视频总时长
                vdMetaInfo.videoDuration = videoModel.getVideoDuration();
            } else {
                // 直播 填 “直播名称”  点播 填 “-”
                videoInfo.VideoTVChannel = videoModel.getLiveName();
            }
            // 各级栏目名称   /体育/篮球/NBA/
            videoInfo.setVideoWebChannel(videoModel.getlName());

            Log.e(TAG, "栏目名称：" + videoModel.getlName());

            if (isVod) {
                VodInfoProvider mVoideInfoProvider = new VodInfoProvider();
                mVodPlay = tracker.newVodPlay(videoInfo, mVoideInfoProvider);
            } else {
                LiveInfoProvider mLiveInfoProvider = new LiveInfoProvider();
                mLivePlay = tracker.newLivePlay(videoInfo, mLiveInfoProvider);
            }

        } catch (Exception e) {
            e.printStackTrace();
        } catch (OutOfMemoryError error) {
            error.printStackTrace();
        }
    }
```

* vdCount(Boolean isVod, Status status)：开始加载 开始播放 暂停播放 结束播放
```
    /**
     * 开始加载 开始播放 暂停播放 结束播放
     * videoModel 视频实体类
     * isVod true：点播  fasle：直播
     * status 枚举
     */
    public static void vdCount(Boolean isVod, Status status) {

        try {

            //播放状态
            switch (status) {
                case BEGIN_LOAD:
                    //开始加载
                    if (isVod) {
                        mVodPlay.beginPreparing();
                    } else {
                        mLivePlay.beginPreparing();
                    }
                    Log.e(TAG, ">>>>>>>>>>>>>>>>>开始加载<<<<<<<<<<<<<<<");
                    break;
                case START_PLAY:
                    //开始播放
                    if (isVod) {
                        mVodPlay.onStateChanged(GSVideoState.PLAYING);
                    } else {
                        mLivePlay.onStateChanged(GSVideoState.PLAYING);
                    }
                    Log.e(TAG, ">>>>>>>>>>>>>>>>>开始播放<<<<<<<<<<<<<<<");
                    break;
                case PAUSE_PLAY:
                    //暂停播放
                    if (isVod) {
                        mVodPlay.onStateChanged(GSVideoState.PAUSED);
                    } else {
                        mLivePlay.onStateChanged(GSVideoState.PAUSED);
                    }
                    Log.e(TAG, ">>>>>>>>>>>>>>>>>播放暂停<<<<<<<<<<<<<<<");
                    break;
                case END_PLAY:
                    //结束播放 下一集
                    if (isVod) {
                        mVodPlay.onStateChanged(GSVideoState.STOPPED);
                        mVodPlay.endPlay();
                    } else {
                        mLivePlay.onStateChanged(GSVideoState.STOPPED);
                        mLivePlay.endPlay();
                    }
                    Log.e(TAG, ">>>>>>>>>>>>>>>>>播放完成<<<<<<<<<<<<<<<");
                    break;
            }
        } catch (Exception e) {
        }
    }
```

* vdEndLoadCount(Boolean isVod, Boolean isSuccess)：结束加载 
```
    /**
     * 结束加载  加载是否成功
     * videoModel 视频实体类
     * isVod true：点播  fasle：直播
     * isSuccess true：视频加载成功  false:视频加载失败
     */
    public static void vdEndLoadCount(Boolean isVod, Boolean isSuccess) {

        try {
            //结束加载   加载是否成功
            if (isVod) {
                mVodPlay.endPreparing(isSuccess, vdMetaInfo);

            } else {
                mLivePlay.endPreparing(isSuccess, liveMetaInfo);

            }
            if (isSuccess) {
                Log.e(TAG, ">>>>>>>>>>>>>>>>>加载完成<<<<<<<<<<<<<<<");
            } else {
                Log.e(TAG, ">>>>>>>>>>>>>>>>>加载失败<<<<<<<<<<<<<<<");
            }
        } catch (Exception e) {
        }
    }
```

* onResume()：视频统计显示
```
    /**
     * 视频统计显示
     */
    public static void onResume() {
        try {
            switch (videoType) {
                case 0:
                    if (mVodPlay != null) {
                        mVodPlay.setVisibility(true);
                    }
                    break;
                case 1:
                    if (mLivePlay != null) {
                        mLivePlay.setVisibility(true);
                    }
                    break;
            }
        } catch (Exception e) {
        }
    }
```

* onPause()：视频统计隐藏
```
    /**
     * 视频统计隐藏
     */
    public static void onPause() {
        try {
            switch (videoType) {
                case 0:
                    if (mVodPlay != null) {
                        mVodPlay.setVisibility(false);
                    }
                    break;
                case 1:
                    if (mLivePlay != null) {
                        mLivePlay.setVisibility(false);
                    }
                    break;
            }
        } catch (Exception e) {
        }
    }
```

* onDestroy()：视频统计销毁
```
    /**
     * 视频统计销毁
     */
    public static void onDestroy() {
        try {
            switch (videoType) {
                case 0:
                    if (mVodPlay != null) {
                        mVodPlay.endPlay();
                        mVodPlay = null;
                    }
                    break;
                case 1:
                    if (mLivePlay != null) {
                        mLivePlay.endPlay();
                        mLivePlay = null;
                    }
                    break;
            }
            Log.e(TAG, ">>>>>>>>>>>>>>>>>播放结束<<<<<<<<<<<<<<<");
        } catch (Exception e) {
        }
    }
```

* enum Status：枚举状态
```
    /**
     * BEGIN_LOAD：开始加载
     * END_COMPLETE：结束加载
     * START_PLAY：开始播放
     * PAUSE_PLAY：暂停播放
     * END_PLAY：结束播放
     */
    public enum Status {
        BEGIN_LOAD, END_COMPLETE, START_PLAY, PAUSE_PLAY, END_PLAY
    }
```

##### 使用方法 （LivePlayActivity页面里有使用方法，以下只是举个例子）

```
    /**
     * 其实点播比直播多个参数而已
     * mVideoModel.setVideoDuration(0d); /时长
     */

    //直播
    VideoModel mVideoModel = new VideoModel();
    // 埋码 视频统计-视频信息
    if (mVideoModel != null) {
        mVideoModel.setCdn(data3.getHls_cdn_info().getCdn_name());
       //设置视频地址
       mVideoModel.setVdUrl(playDoInfo.getUrl());
       //设置视频id
       mVideoModel.setVid(playDoInfo.getVid());
       String path = null;
       if (playDoInfo.getModule() == null || playDoInfo.getModule().length() == 0) {
           path = "/" + strPage + "/列表/";
          } else {
           path = "/" + strPage + "/" + playDoInfo.getModule() + "/";
          }
       //设置栏目名
       mVideoModel.setlName(path);
       //设置标题
       mVideoModel.setVdName(playDoInfo.getTitle());
       mVideoModel.setLiveName(playDoInfo.getTitle());
       //数据统计
       CountEnUtils.vdCount(mContext, mVideoModel, !isLive);
    }

    //点播
    VideoModel mVideoModel = new VideoModel();
    mVideoModel.setCdn(cdnName);
    //时长
    if (data1.getVideo() != null && !TextUtils.isEmpty(data1.getVideo().getTotalLength())) {
        mVideoModel.setVideoDuration(Double.valueOf(data1.getVideo().getTotalLength()));
    } else {
        mVideoModel.setVideoDuration(0d);
    }
    // 埋码 视频统计-视频信息
    if (mVideoModel != null) {
       //设置视频地址
       mVideoModel.setVdUrl(playDoInfo.getUrl());
       //设置视频id
       mVideoModel.setVid(playDoInfo.getVid());
       String path = null;
       if (playDoInfo.getModule() == null || playDoInfo.getModule().length() == 0) {
           path = "/" + strPage + "/列表/";
          } else {
           path = "/" + strPage + "/" + playDoInfo.getModule() + "/";
          }
       //设置栏目名
       mVideoModel.setlName(path);
       //设置标题
       mVideoModel.setVdName(playDoInfo.getTitle());
       mVideoModel.setLiveName(playDoInfo.getTitle());
       //数据统计
       CountEnUtils.vdCount(mContext, mVideoModel, !isLive);
    }

    // 埋码 视频统计-播放暂停
    CountEnUtils.vdCount(!isLive, CountEnUtils.Status.PAUSE_PLAY);
    // 埋码 视频统计-开始加载
    CountEnUtils.vdCount(!isLive, CountEnUtils.Status.BEGIN_LOAD);
    // 埋码 视频统计-加载完成
    CountEnUtils.vdEndLoadCount(!isLive, true);
    // 埋码 视频统计-开始播放
    CountEnUtils.vdCount(!isLive, CountEnUtils.Status.START_PLAY);
    // 埋码 视频统计-加载失败
    CountEnUtils.vdEndLoadCount(!isLive, false);
    // 埋码 视频统计-播放完成
    CountEnUtils.vdCount(!isLive, CountEnUtils.Status.END_PLAY);
    // 埋码 视频统计-隐藏
    CountEnUtils.onPause();
    // 埋码 视频统计-显示
    CountEnUtils.onResume();
    // 埋码 视频统计-销毁
    CountEnUtils.onDestroy();

```

## 播放器
### 播放器常用类
* LivePlayActivity.class   播放器底层页类  （处理播放器业务，调取接口等）
* IpandaLiveVideo.class    播放器UI类（处理播放器UI等，占位图、选集、码率）
* BaseVideoActivity.class  播放器基类 （处理网络切换状态）
* GSYVideoView.class  播放器回调与状态类 （处理播放器相关回调）
* GSYVideoControlView.class 播放器控制类 （UI的显示、控制层、手势处理）

#### LivePlayActivity
##### 接口
* 获取视频信息接口，关键字：WHAT_VIDEO_INFO
* 获取点播播放视频信息，关键字：WHAT_VIDEO_PLAYURL
* 获取点播选集列表，关键字：WHAT_VIDEO_LIST
* 获取直播播放视频信息，关键字：WHAT_GET_LIVE_DATA
* 点赞，关键字：WHAT_PRAISEADD
* 获取点赞数，关键字：WHAT_GETPRAISENUM

##### 播放器相关
* 设置标题
```
videoPlayer.getTitleTextView().setText("标题");
```
* 选集点击事件：adapter.setOnItemClickListener
* 播放器进度监听：videoPlayer.setGSYVideoProgressListener
* 设置播放进度： getCurPlay().setSeekOnStart(Long.valueOf(lastPosition) * 1000);
* 开始播放： getCurPlay().startPlayLogic();
* play() 处理了网络切换、视频暂停、恢复等


#### IpandaLiveVideo
* 自动播放下一集处理：doAutoPlay()
* 视频加载UI：changeUiToPrepareing()
* 准备完成，开始播放：onAfterPreparedPlay()
* 切换分辨率：switchQuality()

#### BaseVideoActivity
* 网络状态监听：onReceive
```
        @Override
        public void onReceive(Context context, Intent intent) {
            String action = intent.getAction();
            if (action != null) {
                // 网络状态变化
                if (ConnectivityManager.CONNECTIVITY_ACTION.equals(action)) {
                    int state = FunctionUtils.getNetworkState(context);
                    if (flag) {
                        if (state == NETWORN_NONE) {
                            isPlayFlag = false;
                            // 无网络
                            ToastManager.show("No connection");
                            dismissLoadDialog();
                            noNetShow();
                        } else if (state == NETWORN_WIFI || state == NETWORN_2G || state == NETWORN_3G || state == NETWORN_4G ||
                            state == NETWORN_MOBILE) {
                            //网络切换、4g换wifi 等
                            Log.e("CXP","网络切换");
                            play();  //这个方法是LivePlayActivity页面的，里面有播放器处理逻辑
                            isPlayFlag = true;
                            isNotNetWork = true;
                        }
                    }
                }
            }
```

#### GSYVideoView
##### 视频播放完成：onAutoCompletion  （这个播放完成包括，播放完缓存、正常播放完成）
* 播放完缓存
```
   断网播放完缓存：setStateAndUi(CURRENT_STATE_ERROR);  黑屏
   联网播放完缓存：
   if (getBuffterPoint() < getDuration()) {
       getGSYVideoManager().getMediaPlayer().seekTo(getGSYVideoManager().getMediaPlayer().getCurrentPosition());
       getGSYVideoManager().getMediaPlayer().start();
       return;
    }
```
* 正常播放完成
```
正常播放完成：setStateAndUi(CURRENT_STATE_AUTO_COMPLETE);
```

##### 恢复暂停状态：onVideoResume
* 后台切回前台走这个方法

##### 暂停状态：onVideoPause
* 前台切回后台走这个方法


#### GSYVideoControlView
* 进度回调：setGSYVideoProgressListener
* 拖动进度条：onStopTrackingTouch
* 播放器触摸事件：onTouch
* 屏幕双击：onDoubleTap
* 屏幕单击：onSingleTapConfirmed
* 设置播放显示状态：setStateAndUi
* 滑动进度系数：mSeekRatio

### 更多用法
* 参考资料：https://github.com/CarGuo/GSYVideoPlayer/wiki